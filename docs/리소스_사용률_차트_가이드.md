# 리소스 사용률 시각화 가이드

## 개요
이 가이드는 제조 시뮬레이션 프레임워크에서 리소스들의 시간에 따른 사용률을 선형 차트로 시각화하는 방법을 설명합니다.

## 주요 기능

### 1. 시간별 사용률 타임라인 차트
리소스들의 사용률 변화를 시간에 따라 선형 차트로 표시합니다.

### 2. 실시간 사용률 막대 차트
현재 시점의 모든 리소스 사용률을 막대 차트로 비교 표시합니다.

### 3. 특정 리소스 트렌드 비교
선택한 리소스들의 사용률 트렌드를 비교 분석합니다.

## 기본 사용법

### 1. ReportManager 설정

```python
import simpy
from src.core.report_manager import create_report_manager

# SimPy 환경 생성
env = simpy.Environment()

# ReportManager 생성 (시각화 기능 포함)
report_manager = create_report_manager(env)
```

### 2. 리소스 등록

```python
# 리소스들을 ReportManager에 등록
report_manager.register_resource("machine_01", machine1)
report_manager.register_resource("machine_02", machine2)
report_manager.register_resource("transport_01", transport1)
```

### 3. 사용률 타임라인 차트 생성

```python
# 모든 등록된 리소스의 사용률 타임라인 차트
chart_path = report_manager.generate_utilization_timeline_chart(
    hours=24,  # 최근 24시간 데이터
    save_path="resource_utilization_timeline.png",
    title="제조라인 리소스 사용률 변화"
)
```

### 4. 특정 리소스만 선택하여 차트 생성

```python
# 특정 리소스들만 선택
selected_resources = ["machine_01", "machine_02"]
chart_path = report_manager.generate_utilization_timeline_chart(
    resource_ids=selected_resources,
    hours=12,  # 최근 12시간
    title="주요 기계 사용률 비교"
)
```

### 5. 실시간 사용률 막대 차트

```python
# 현재 시점 사용률 막대 차트
current_chart = report_manager.generate_real_time_utilization_chart(
    save_path="current_utilization.png"
)
```

### 6. 리소스 트렌드 비교

```python
# 특정 리소스들의 트렌드 비교
comparison_chart = report_manager.compare_resource_utilization_trends(
    resource_ids=["machine_01", "machine_02", "machine_03"],
    hours=8,
    save_path="resource_comparison.png"
)
```

## 고급 활용

### 1. 시계열 데이터 직접 추출

```python
# 원시 데이터 추출
timeline_data = report_manager.extract_resource_utilization_timeline(
    resource_ids=["machine_01", "machine_02"],
    hours=24
)

# 데이터 구조: {resource_id: [(time, utilization), ...]}
for resource_id, data_points in timeline_data.items():
    print(f"리소스 {resource_id}: {len(data_points)}개 데이터 포인트")
    for time_point, utilization in data_points:
        print(f"  시간 {time_point:.1f}: 사용률 {utilization:.1%}")
```

### 2. 커스텀 차트 생성

```python
# VisualizationManager 직접 사용
timeline_data = report_manager.extract_resource_utilization_timeline()

# 시간 데이터와 사용률 데이터 분리
time_points = list(set([t for data in timeline_data.values() for t, _ in data]))
time_points.sort()

utilization_series = {}
for resource_id, data_points in timeline_data.items():
    # 시간 포인트별 사용률 매핑
    util_dict = {t: u for t, u in data_points}
    utilization_series[resource_id] = [util_dict.get(t, 0) for t in time_points]

# 다중 선형 차트 생성
report_manager.visualization_manager.plot_multi_line_chart(
    time_data=time_points,
    data_series=utilization_series,
    title="커스텀 리소스 사용률 차트",
    x_label="시뮬레이션 시간",
    y_label="사용률",
    save_path="custom_utilization_chart.png"
)
```

## 차트 커스터마이징

### 1. 색상 및 스타일 설정

```python
# VisualizationManager를 통한 세부 설정
colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7']
line_styles = ['-', '--', '-.', ':', '-']

report_manager.visualization_manager.plot_multi_line_chart(
    time_data=time_points,
    data_series=utilization_series,
    title="색상 커스터마이징된 사용률 차트",
    colors=colors,
    line_styles=line_styles,
    save_path="custom_styled_chart.png"
)
```

### 2. 차트 크기 및 해상도 조정

차트는 기본적으로 고해상도(300 DPI)로 저장되며, 크기는 용도에 따라 자동 조정됩니다:
- 타임라인 차트: 14×8 인치
- 막대 차트: 10×6 인치
- 다중 선형 차트: 12×8 인치

## 데이터 분석 활용

### 1. 사용률 통계 정보

```python
# 사용률 타임라인 생성 시 자동으로 통계 정보가 출력됩니다
chart_path = report_manager.generate_utilization_timeline_chart()

# 출력 예시:
# === 리소스 사용률 요약 ===
# 리소스 machine_01:
#   - 평균 사용률: 75.3%
#   - 최대 사용률: 98.5%
#   - 최소 사용률: 12.1%
#   - 현재 사용률: 82.4%
#   - 데이터 포인트 수: 144
```

### 2. 병목 지점 식별

```python
# 높은 사용률을 가진 리소스 식별
current_utilization = report_manager._calculate_resource_utilization()
high_utilization_resources = {
    rid: util for rid, util in current_utilization.items() 
    if util > 0.9  # 90% 이상
}

print("병목 가능성이 높은 리소스들:")
for resource_id, utilization in high_utilization_resources.items():
    print(f"  {resource_id}: {utilization:.1%}")
```

### 3. 트렌드 분석

```python
# 리소스별 트렌드 분석
timeline_data = report_manager.extract_resource_utilization_timeline(hours=24)

for resource_id, data_points in timeline_data.items():
    if len(data_points) < 2:
        continue
        
    # 사용률 변화 계산
    start_util = data_points[0][1]
    end_util = data_points[-1][1]
    change = end_util - start_util
    
    trend = "증가" if change > 0.05 else "감소" if change < -0.05 else "안정"
    print(f"리소스 {resource_id}: {trend} 트렌드 (변화량: {change:+.1%})")
```

## 실시간 모니터링

### 1. 주기적 차트 업데이트

```python
def update_utilization_charts():
    """주기적으로 사용률 차트를 업데이트하는 함수"""
    
    # 타임라인 차트 업데이트
    timeline_chart = report_manager.generate_utilization_timeline_chart(
        hours=6,  # 최근 6시간
        save_path=f"utilization_timeline_latest.png",
        show_chart=False  # 화면에 표시하지 않고 저장만
    )
    
    # 실시간 막대 차트 업데이트
    current_chart = report_manager.generate_real_time_utilization_chart(
        save_path="utilization_current_latest.png"
    )
    
    return timeline_chart, current_chart

# 시뮬레이션 중 주기적 호출
# (실제 구현에서는 SimPy 프로세스나 이벤트를 통해 호출)
```

### 2. 알림 기반 차트 생성

```python
def alert_callback(alert):
    """알림 발생 시 관련 차트 생성"""
    if alert['severity'] == 'critical' and 'utilization' in alert['metric_name']:
        resource_id = alert['component_id']
        
        # 해당 리소스의 상세 트렌드 차트 생성
        report_manager.compare_resource_utilization_trends(
            resource_ids=[resource_id],
            hours=4,
            save_path=f"alert_utilization_{resource_id}_{int(time.time())}.png"
        )

# 알림 콜백 등록
report_manager.alert_system.register_alert_callback(alert_callback)
```

## 주의사항

### 1. 데이터 수집 주기
- 리소스 상태는 실시간으로 추적되지만, 차트에 표시되는 데이터 포인트는 상태 변화 시점에만 생성됩니다.
- 더 세밀한 시간 간격의 데이터가 필요한 경우, 주기적으로 `track_resource_state()`를 호출해야 합니다.

### 2. 메모리 사용량
- 기본적으로 최대 1000개의 히스토리 포인트가 저장됩니다.
- 장시간 시뮬레이션의 경우 `max_history` 파라미터를 조정하여 메모리 사용량을 관리하세요.

### 3. 파일 저장
- 모든 차트는 `visualizations/` 폴더에 저장됩니다.
- 기존 파일을 덮어쓰지 않도록 타임스탬프가 포함된 파일명을 사용하는 것을 권장합니다.

## 문제 해결

### 차트가 생성되지 않는 경우
1. 리소스가 제대로 등록되었는지 확인
2. 충분한 히스토리 데이터가 있는지 확인
3. matplotlib 라이브러리가 설치되어 있는지 확인

### 데이터가 표시되지 않는 경우
1. 리소스 객체에 `get_utilization()` 메서드가 구현되어 있는지 확인
2. 시뮬레이션이 충분히 진행되었는지 확인
3. 요청한 시간 범위에 데이터가 있는지 확인

이 가이드를 통해 리소스 사용률을 효과적으로 시각화하고 분석할 수 있습니다.
